## Реферальная программа — план реализации

### Цели
- Увеличение регистраций и заказов за счет рекомендаций.
- Вознаграждение реферера после успешной оплаты заказа рефералом.

### KPI
- Кол-во приглашений → конверсии в заказ.
- Кол-во выданных/использованных бонусов.
- CAC/ROI канала «реферал».

---

## Архитектура и компоненты
- Источник правды: внешняя Saleor App (вебхуки + GraphQL), отдельная БД.
- Хранение кода реферала: в `User.metadata` и отдельной таблице `referral_codes`.
- Трекинг: `Checkout.metadata.ref_code` → перенос в `Order.metadata.ref_code`.
- Триггер бонуса: вебхук `ORDER_CONFIRMED` (или `ORDER_PAID`) → проверка условий → `giftCardCreate`/`voucherCreate` для реферера.
- Коммуникации: письмо рефереру с кодом/подарочной картой (через существующий почтовый бэкенд).

---

## Модель данных (App DB)
- `referral_codes`:
  - `id` (uuid)
  - `code` (uniq, пример: 6–8 символов)
  - `referrer_user_id` (Saleor `User.id`)
  - `status` (active|disabled)
  - `created_at`
- `referrals`:
  - `id` (uuid)
  - `ref_code`
  - `referred_customer_id` (Saleor `User.id`, может быть null до регистрации)
  - `order_id` (Saleor `Order.id` при наличии)
  - `state` (tracked|paid|rewarded|rejected)
  - `reason` (для отказов/антифрода)
  - `created_at`, `updated_at`
- `rewards`:
  - `id` (uuid)
  - `referral_id`
  - `type` (gift_card|voucher)
  - `amount` (decimal), `currency`
  - `gift_card_id`/`voucher_id` (GraphQL id)
  - `status` (issued|delivered|used|expired)
  - `created_at`

---

## Пользовательские потоки
1) Генерация реферального кода
   - Пользователь в личном кабинете получает свой код (если нет — сгенерировать и сохранить).
2) Захват реферала
   - Лендинг/магазин принимает `?ref=CODE` → кладет в `localStorage`/cookie.
   - При создании checkout: добавить `ref_code` в `Checkout.metadata`.
3) Конверсия и награда
   - После оплаты заказа вебхук `ORDER_CONFIRMED`:
     - извлечь `order.metadata.ref_code`;
     - найти реферера по `referral_codes`;
     - антифрод-проверки;
     - выдать бонус (gift card/voucher) рефереру;
     - записать `rewards` и отправить письмо.

---

## Интеграция с Saleor
### Метаданные
- `User.metadata.ref_code`
- `Checkout.metadata.ref_code`
- `Order.metadata.ref_code`

### Вебхуки (App)
- `ORDER_CONFIRMED` (рекомендуется) или `ORDER_PAID` — основной триггер.
- Дополнительно: `CUSTOMER_CREATED` — связывать приглашенного с кодом (если checkout был анонимным).

### GraphQL операции (App → Saleor)
- Начисление бонуса (вариант A — подарочная карта): `giftCardCreate` с `userEmail` реферера.
- Начисление бонуса (вариант B — ваучер): `voucherCreate` (одноразовый/многоразовый, категория скидок «Referral»).
- Служебно: чтение заказов/пользователей/метаданных при валидации.

---

## Правила выдачи бонуса
- Событие: заказ реферала подтвержден/оплачен.
- Фильтры:
  - минимальная сумма (например, ≥ X в валюте канала);
  - канал/страна/категории допуска;
  - покупатель новый (order count == 1) — опционально;
  - исключить самореферал (совпадение email, device fingerprint — если есть).
- Ограничения:
  - 1 награда за 1 реферала (по `referred_customer_id` или email);
  - дневные/месячные лимиты на выдачу (per user);
  - срок действия бонуса (если ваучер).

---

## Антифрод (минимально необходимое)
- Самореферал: запрет, если `referrer_user_id == referred_customer_id` или совпадает email.
- Повторные бонусы: уникальность по паре (ref_code, referred_customer_id) или (ref_code, order_id).
- Списки исключений: служебные домены почты, тестовые пользователи/каналы.

---

## Изменения в Dashboard (минимум)
- Страница профиля пользователя: показать его реферальный код, кнопку «Скопировать».
- Раздел «Маркетинг → Рефералы»: таблицы рефералов/награды, фильтры, экспорт CSV.
- Теги/пометки подарочных карт/ваучеров: `tags: ["referral"]` для аналитики.

---

## Техническая реализация App
- Стек: FastAPI/Node (любой), подписка на вебхуки, секреты через env.
- Эндпоинты:
  - `POST /webhooks/order-confirmed` — обработчик триггера.
  - `GET /health` — healthcheck.
  - `POST /codes/issue` — генерация кода для пользователя (админ-операция).
- Конфиг:
  - `SALEOR_API_URL`, `SALEOR_TOKEN`, `REFERRAL_REWARD_AMOUNT`, `REFERRAL_REWARD_CURRENCY`, `REWARD_TYPE` (gift_card|voucher).
- Безопасность: валидация подписи вебхуков (HMAC), idempotency ключ (order id + event id).

---

## Тестирование
- Юниты: парсер вебхуков, правила антифрода, генератор кодов.
- Интеграция: e2e сценарий «приглашение → заказ → выдача бонуса → письмо → погашение».
- Нагрузочные: массовая обработка событий без двойной выдачи (idempotency).

---

## Поэтапный rollout
1) Beta: ручная выдача бонусов из админки (кнопка «Выплатить»), логирование.
2) Auto-on для ограниченной группы (фича-флаг).
3) Полный запуск + мониторинг ошибок/отказов.

---

## Бэклог улучшений
- Двусторонний бонус (реферер + реферал).
- Динамический размер бонуса (зависит от корзины/категорий/канала).
- Дерево рефералов (многоуровневая программа) — опционально.
- Виджет шаринга (UTM/сокращатель ссылок).

---

## Минимальные требования к продакшену
- Хранилище и резервное копирование БД App.
- Логи/метрики (успешные/неуспешные выдачи, повторы событий).
- Алёрты при росте отказов/дублирующих выдач.


